-- -*- mode: lua; coding: windows-1251-dos -*-

local vip_npc = {
  [ "akill_npc"            ] = true, -- Акилл в ВП
  [ "andersen"             ] = true, -- Андерсен в подвале
  [ "amk_artem_kulinar"    ] = true, -- Артем Кулинар
  [ "amk_vitek_voron"      ] = true, -- Ворон
  [ "bar_bar_guard"        ] = true, -- Гарик
  [ "bar_dolg_petrenko"    ] = true, -- Петренко
  [ "black_doctor"         ] = {     -- голограмма ЧД в Госпитале
    [ "ignore_hit" ] = true,
  },
  [ "chernomor_zombi1"     ] = true, -- зомбированный Черномор
  [ "dead_city_molniy"     ] = {     -- Молния в МГ
    [ "ignore_hit" ] = true,
  },
  [ "esc_bridge_soldier5"  ] = true, -- Кузнецов
  [ "esc_stalk_shuher"     ] = true, -- Шухер в ДН
  [ "gen_andersen1"        ] = true, -- Андерсен на базе
  [ "gen_sapsan1"          ] = true, -- переговорщик от ЧД
  [ "gen_solvador1"        ] = true, -- Сольвадор лезет в мины
  [ "gen_svoboda_parlamenter" ] = true, -- переговорщик от свободовцев
  [ "gener_bl_doktor1"     ] = {     -- голограмма ЧД на Генераторах
    [ "ignore_hit" ] = true,
  },
  [ "generators_black_dok" ] = {     -- голограмма ЧД на Генераторах
    [ "ignore_hit" ] = true,
  },
  [ "generators_zvezdochet" ] = { -- убегающий Звездочет
    [ "ignore_hit" ] = true,
  },
  [ "himik_trup"           ] = true, -- оживленный Химик
  [ "hospital_bl_dok"      ] = {     -- голограмма ЧД в Госпитале
    [ "ignore_hit" ] = true,
  },
  [ "kalmyak"              ] = true, -- Калмык
  [ "land_lazaret_starik"  ] = true, -- Старик на НЗ
  [ "marsh_udav"           ] = true, -- Боцман на Болотах
  [ "mil_Svoboda_trader"   ] = true, -- Скряга
  [ "mon_stalker"          ] = {     -- Представитель Осознания
    [ "ignore_hit" ] = true,
  },
  [ "sak_military_stalker" ] = true, -- Шерстюк
  -- Кислый на АС, фотографию которого мы сделали с вышки.
  [ "stalker_kisluy"       ] = true,
  [ "val_bandit_trader"    ] = true, -- Жила
  [ "val_lager_bandits_borov" ] = true, -- Боров
  -- Двое на Янтаре с телефоном, которых нужно довести до бункера.
  [ "arhara_ecolog_guard1" ] = true,
  [ "arhara_ecolog_guard2" ] = true,
  -- компания Шахтера в Пещере
  [ "peshera_stahanov"     ] = true,
  [ "peshera_xabaruch"     ] = true,
  [ "peshera_plennyi"      ] = true,
  -- пленный Фима Уголь в Лабиринте
  [ "labirint_monolit_shahter" ] = true,
  [ "rostok_stalker"       ] = true,  -- Фримен
  [ "warlab_sekret_ekolog1" ] = true, -- Лентяй в Варлабе
  [ "tehnik_golograma"     ] = true,  -- Голограма на НЗ по пути на АС
  [ "grom_npc"             ] = true,  -- Гром на Янтаре
  [ "nebo_kurier"          ] = true,  -- курьер Свиблова на Радаре
  [ "bar_arena_man"        ] = true,  -- Арни
  [ "aver_odnonogiy"       ] = true,  -- Одноногий на НЗ
}

local vip_npc_info = {
  -- банда Химеры на НЗ будут неуязвимыми до взятия задания на бритву
  [ "land_arhara_sniper" ] = {
    [ "after"  ] = "ginekolog_lekarstvo_nayti_have",
    [ "before" ] = "piligrim_britva_nayti_start",
  },

  -- чистонебовец на Болотах, который ставит метки за телевизор
  [ "agr_nebo_trader"    ] = {
    [ "before" ] = "need_televizor_done",
  },

  -- Волк на АС
  [ "esc_wolf"           ] = {
    [ "after"  ] = "agroprom_military_case_have",
  },

  -- Костыльнога
  [ "esc_pantera_zadan_soldier" ] = {
    [ "before" ] = "kostylnoga_done",
  },

  -- Гавр с телохранителями будут неуязвимы до последнего диалога
  [ "mil_trader_gavr"    ] = {
    [ "before" ] = "info_gavr_dead",
  },
  [ "mil_gavr_bodyguard1" ] = {
    [ "before" ] = "info_gavr_dead",
  },
  [ "mil_gavr_bodyguard2" ] = {
    [ "before" ] = "info_gavr_dead",
  },

  -- Крысюк
  [ "val_bandit_krisyk"  ] = {
    [ "before" ] = "bandit_krisyk_finish",
  },

  -- раненный военный, с подбитого вертолета на НЗ
  [ "muha_soldat_ranen"  ] = {
    [ "before" ] = "soldier_ranen_say_start",
  },

  -- Кащей на Болотах, около мех. двора, по заданию Свиблова на ПКМ.
  [ "kashei"             ] = {
    [ "before" ] = "sveeblov_ferma_begin",
  },

  -- Трансмутатор. Часовой, который забирает водку и пьяный капитан.
  [ "agro_chsovoy_trezv" ] = {
    [ "before" ] = "chasovoy_trezv_say_start",
  },
  [ "trezv_kapitan"      ] = {
    [ "before" ] = "chasovoy_trezv_say_start",
  },

  -- Охрана Злобного на входе в МГ. Бессмертные до разговора с Парфюмером.
  [ "dcity_last_vhod_1"  ] = {
    [ "before" ] = "parfumer_say_one_start",
  },
  [ "dcity_last_vhod_2"  ] = {
    [ "before" ] = "parfumer_say_one_start",
  },
  [ "dcity_last_vhod_3"  ] = {
    [ "before" ] = "parfumer_say_one_start",
  },
  [ "dcity_last_vhod_4"  ] = {
    [ "before" ] = "parfumer_say_one_start",
  },

  -- Джеймс на ДТ, с кейсом для Фримена.
  [ "bar_rostok_james"   ] = {
    [ "before" ] = "freeman_case_speak",
  },

  -- Хог, у которого плоть сожрала вещи.
  [ "svalka_plot_stalk"  ] = {
    [ "before" ] = "plot_dialog_say_done",
  },

  -- Черномор
  [ "yantar_chernomor"   ] = {
    [ "before" ] = "molniya_plastilin_ok_start",
  },

  -- Джокер и Скромный по сюжету поиска Раби
  [ "djoker"             ] = {
    [ "before" ] = "kot_find_rabi_djoker_vodka",
  },
  [ "scromnyi"           ] = {
    [ "before" ] = "kot_find_rabi_scromnyi",
  },

  -- Блэнд в ТД, у которого нужно взять bland_flash
  [ "dark_bland"         ] = {
    [ "before" ] = "bland_say_war",
  },

  -- Кэп на АС, до получения сломанного огнемета
  [ "mil_blockpost_freedomstalker001" ] = {
    [ "before" ] = "mil_fblockpost_quest_reward",
  },

  -- Пригоршня в Забытом Лесу
  [ "prigorshnya_zl" ] = {
    [ "after" ] = "prigorshnya_stop",
  },

  -- Сталкеры в МГ
  [ "city_starshoy"        ] = { -- Тюменский
    [ "before" ] = "starshoy_say_one_done",
  },
  [ "city_tema_likvidator" ] = { -- Тема Ликвидатор
    [ "before" ] = "tema_talk_one_start",
  },
  [ "dcity_dozor_stalk"    ] = { -- и его напарник
    [ "before" ] = "tema_talk_one_start",
  },

  -- Обморок в МГ
  [ "dcity_obmorok" ] = {
    [ "before" ] = "agro_tainik_norman_done",
  },

  -- Лейтенант Морозко, которого нужно проводить с Юпитера
  [ "leteha_morozko" ] = {
    [ "after" ] = "morozko_start",
  },

  -- Толик должен быть бессмертным до лечения, а то его кто-нибудь съест.
  [ "esc_vagon_wounded" ] = {
    [ "before" ] = "esc_wounded_arrive",
  },

  -- Охотники в Красном Лесу должны дождаться, когда герой им принесет
  -- рюкзак с Болот, который Митяй утащил.
  [ "green_forest" ] = {
    [ "before" ] = "klyak_forest_doc_green",
  },

  -- Крот на Агропроме, пока не соберется уходить.
  [ "agr_krot" ] = {
    [ "before" ] = "agr_find_gunslinger_cache_found",
  },

  -- Митя и К
  [ "mitya_marsh" ] = {
    [ "before" ] = "klyak_forest_doc_scene",
  },
  [ "grab_mitya_marsh" ] = {
    [ "before" ] = "klyak_forest_doc_scene",
  },

  -- Круглов на Янтаре
  [ "yan_scientist_help" ] = {
    [ "after" ] = "yan_find_scientist_done",
  },

  -- Прорыв в Припяти
  [ "pri_followers" ] = {
    [ "before" ] = "pri_followers_scene_end",
  },

  [ "dyak" ] = {                -- Дьяк
    [ "before" ] = {
      "dyak_help_done",
      "koloda_dyak",
      "ohota_biblik_done",
    },
  },

  -- Сахатый, пленник в церкви при первом заходе на Болота
  [ "esc_saha" ] = {
    [ "before" ] = "dyak_help_done",
  },

  -- Раненный Денис в КЛ
  [ "forest_wound" ] = {
    [ "before" ] = "denis_wound_have",
  },

  -- Злобный на НЗ
  [ "aver_zlobnuy" ] = {
    [ "before" ] = "proval_strelki",
  },

  -- Юрик и драма на Свалке
  [ "gar_dm_novice" ] = {
    [ "before" ] = "gar_dm_novice_change_st",
  },

  -- Монгол в ТД
  [ "val_escort_bandit_halfdead" ] = {
    [ "before" ] = "val_bandit_talk",
  },

  -- Мессер в ТД
  [ "val_sos" ] = {
    [ "before" ] = "val_sos_got_medkit",
  },
}


function attach( sm )
  sm:subscribe({ signal = "on_npc_before_hit", fun = this.on_npc_before_hit })
end


function is_vip_npc( obj )
  local is_vip = vip_npc[ obj:name() ] or vip_npc[ obj:profile_name() ]
    or false
  if not is_vip then
    local info = vip_npc_info[ obj:name() ]
      or vip_npc_info[ obj:profile_name() ]
    if not info then
      local strn, begin_job = dsh_enemies.get_smart_terrain( obj )
      if strn and begin_job then
        info = vip_npc_info[ strn:name() ]
      end
    end
    if not info then return false end
    if info.after and info.before then
      if
        has_all_info( info.after ) and not has_all_info( info.before )
      then
        is_vip = info
      end
    elseif info.before then
      if not has_all_info( info.before ) then
        is_vip = info
      end
    elseif info.after then
      if has_all_info( info.after ) then
        is_vip = info
      end
    else
      is_vip = false
    end
  end
  return is_vip
end


function has_all_info( info )
  if type( info ) ~= "table" then info = { info } end
  for _, name in ipairs( info ) do
    if db.actor:dont_has_info( name ) then return false end
  end
  return true
end


local cache = {}
local freq  = 500

function on_npc_before_hit( obj, hit_data )
  local id = obj:id()
  local is_vip
  if cache[ id ] then
    local res, ttl = unpack( cache[ id ] )
    if ttl < time_global() then
      is_vip = res
    else
      cache[ id ] = nil
    end
  end
  if is_vip == nil then
    is_vip = is_vip_npc( obj )
    cache[ id ] = { is_vip, time_global() + freq }
  end
  if is_vip then
    if type( is_vip ) == "table" and is_vip.ignore_hit then
      hit_data.ignore_hit = true
      return true -- прекратить обработку
    else
      hit_data.power = 0
    end
  end
end
